name: C++ Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # JOB 1: Build the C++ project in both Debug and Release configurations
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # Build two configurations in parallel: Debug and Release
        build_type: [debug, release]
    
    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Install build dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ make

      # Step 3: Compile using g++
      - name: Build ${{ matrix.build_type }}
        run: |
          if [ "${{ matrix.build_type }}" == "debug" ]; then
            g++ -g -std=c++11 -Wall -Werror *.cpp *.h -o process-scheduler-debug
            if [ -f process-scheduler ]; then
              mv process-scheduler process-scheduler-debug
            fi
          else
            g++ -O3 -DNDEBUG -std=c++11 *.cpp *.h -o process-scheduler-release
            if [ -f process-scheduler ]; then
              mv process-scheduler process-scheduler-release
            fi
          fi
      
      # Step 4: Verify binary was created
      - name: Verify binary
        run: |
          ls -lh process-scheduler-${{ matrix.build_type }}
          file process-scheduler-${{ matrix.build_type }}

      # Step 5: Create tarball with binary and Processes folder
      - name: Create tarball
        run: |
          # Create a temporary directory for packaging
          mkdir -p package-${{ matrix.build_type }}
          
          # Copy the binary (rename to remove the build type suffix for user convenience)
          cp process-scheduler-${{ matrix.build_type }} package-${{ matrix.build_type }}/process-scheduler
          
          # Copy the Processes folder
          cp -r Processes package-${{ matrix.build_type }}/
          
          # Create the tarball
          tar -czf process-scheduler-${{ matrix.build_type }}.tar.gz -C package-${{ matrix.build_type }} .
          
          # Verify tarball contents
          echo "Tarball contents:"
          tar -tzf process-scheduler-${{ matrix.build_type }}.tar.gz
      
      # Step 6: Upload the tarball as an artifact
      - name: Upload tarball artifact
        uses: actions/upload-artifact@v4
        with:
          name: tarball-${{ matrix.build_type }}
          path: process-scheduler-${{ matrix.build_type }}.tar.gz
          retention-days: 1

  # JOB 2: Create the GitHub release with tarballs and documentation
  create-release:
    needs: build  # Wait for both Debug and Release builds to complete
    runs-on: ubuntu-22.04
    
    steps:
      # Step 1: Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Download all tarballs from the build job
      - name: Download all tarballs
        uses: actions/download-artifact@v4
        with:
          pattern: tarball-*
          path: tarballs
          merge-multiple: true
      
      # Step 3: List downloaded files for debugging
      - name: List downloaded tarballs
        run: |
          echo "Downloaded tarballs:"
          ls -lh tarballs/

      # Step 4: Release Notes
      - name: Prepare release notes
        run: |
          sed 's/{VERSION}/${{ github.ref_name }}/g' .github/release-notes.md > release-body.md

      # Step 5: Create ZIP archive of documentation
      - name: Create documentation archive
        run: |
          if [ -d "Documentation" ] && [ "$(ls -A Documentation/*.pdf 2>/dev/null)" ]; then
            zip -j documentation.zip Documentation/*.pdf
            echo "Documentation ZIP created"
          else
            echo "No PDF documentation found in Documentation/ folder"
          fi
      
      # Step 6: Create the GitHub release with all assets
      - name: Create Release & Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-body.md
          files: |
            tarballs/process-scheduler-debug.tar.gz
            tarballs/process-scheduler-release.tar.gz
            documentation.zip
          fail_on_unmatched_files: true  # don't produce incomplete releases