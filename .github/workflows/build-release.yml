name: C++ Build & Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # JOB 1: Build the C++ project in both Debug and Release configurations
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # Build two configurations in parallel: Debug and Release
        build_type: [debug, release]
    
    steps:
      # Step 1: Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Install build dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential g++ make

      # Step 3: Compile using g++
      - name: Build ${{ matrix.build_type }}
        run: |
          if [ "${{ matrix.build_type }}" == "debug" ]; then
            g++ -g -std=c++11 -Wall -Werror *.cpp *.h -o process-scheduler-debug
            if [ -f process-scheduler ]; then
              mv process-scheduler process-scheduler-debug
            fi
          else
            g++ -O3 -DNDEBUG -std=c++11 *.cpp *.h -o process-scheduler-release
            if [ -f process-scheduler ]; then
              mv process-scheduler process-scheduler-release
            fi
          fi
      
      # Step 4: Verify binary was created
      - name: Verify binary
        run: |
          ls -lh process-scheduler-${{ matrix.build_type }}
          file process-scheduler-${{ matrix.build_type }}

      
      # Step 5: Upload the compiled binary as an artifact
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.build_type }}
          path: process-scheduler-${{ matrix.build_type }}
          retention-days: 1

  # JOB 2: Create the GitHub release with binaries and documentation
  create-release:
    needs: build  # Wait for both Debug and Release builds to complete
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out the repository
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # Step 2: Download all compiled binaries from the build job
      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          path: binaries
          merge-multiple: true
      
      # Step 3: List downloaded files for debugging
      - name: List downloaded binaries
        run: |
          echo "Downloaded binaries:"
          ls -lh binaries/
      
      # Step 4: Create ZIP archive of documentation
      - name: Create documentation archive
        run: |
          if [ -d "Documentation" ] && [ "$(ls -A Documentation/*.pdf 2>/dev/null)" ]; then
            zip -j documentation.zip Documentation/*.pdf
            echo "Documentation ZIP created"
          else
            echo "No PDF documentation found in Documentation/ folder"
          fi
      
      # Step 5: Create the GitHub release with all assets
      - name: Create Release & Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Process Scheduler ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            üöÄ **CPU Process Scheduler Simulator - Release ${{ github.ref_name }}**
            
            A C++ implementation of various CPU scheduling algorithms including FCFS, SJF, Priority, and Round Robin.
            
            ## üì¶ Downloads
            
            **Pre-compiled Binaries (Linux x64):**
            - `process-scheduler-release` - Optimized production build (recommended)
            - `process-scheduler-debug` - Debug build with symbols for development
            
            **Documentation:**
            - `documentation.zip` - Project documentation (PDFs)
            
            ## üîß Build Information
            - **Compiler:** g++ (Ubuntu)
            - **Standard:** C++11
            - **Build Date:** ${{ github.event.head_commit.timestamp }}
            - **Commit:** ${{ github.sha }}
            
            ## üìù Usage
            ```bash
            # Download and run the Release binary
            chmod +x process-scheduler-release
            ./process-scheduler-release
            ```
            
            ## üêõ Debug Build
            
            For debugging or development:
            ```bash
            chmod +x process-scheduler-debug
            gdb ./process-scheduler-debug
            ```
            
            ## üõ†Ô∏è Building from Source
            ```bash
            git clone https://github.com/ADolbyB/process-scheduler.git
            cd process-scheduler
            ```
            
            Compile with debug symbols
            ```
            g++ -g -std=c++11 -Wall -Werror *.cpp *.h -o sched_driver
            ```

            Launch with GDB
            ```
            gdb ./sched_driver
            ./processScheduler
            ```
            
            See the full source code and detailed instructions in the repository README.
          files: |
            binaries/process-scheduler-debug
            binaries/process-scheduler-release
            documentation.zip
          fail_on_unmatched_files: true  # don't produce incomplete releases